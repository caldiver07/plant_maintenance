from flask import Flask, render_template, request, redirect, url_for
import sqlite3
from datetime import datetime, timedelta

app = Flask(__name__, template_folder='templates')

def init_db():
    with sqlite3.connect('plants.db') as conn:
        cursor = conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS plants (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                species TEXT,
                watering_frequency INTEGER NOT NULL,
                last_watered DATE
            )
        ''')
        conn.commit()

@app.route('/')
def index():
    with sqlite3.connect('plants.db') as conn:
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM plants')
        plants = cursor.fetchall()
        
        plant_list = []
        for plant in plants:
            last_watered = datetime.strptime(plant[4], '%Y-%m-%d').date()
            next_watering = last_watered + timedelta(days=plant[3])
            days_until_watering = (next_watering - datetime.now().date()).days
            plant_list.append({
                'id': plant[0],
                'name': plant[1],
                'species': plant[2],
                'watering_frequency': plant[3],
                'last_watered': last_watered.strftime('%B %d, %Y'),
                'next_watering': next_watering.strftime('%B %d, %Y'),
                'days_until_watering': days_until_watering,
                'needs_water': days_until_watering <= 0
            })

    return render_template('index.html', plants=plant_list)

@app.route('/add', methods=['POST'])
def add_plant():
    name = request.form.get('name')
    species = request.form.get('species')
    watering_frequency = request.form.get('watering_frequency')
    last_watered = datetime.now().strftime('%Y-%m-%d')

    with sqlite3.connect('plants.db') as conn:
        cursor = conn.cursor()
        cursor.execute(
            'INSERT INTO plants (name, species, watering_frequency, last_watered) VALUES (?, ?, ?, ?)',
            (name, species, watering_frequency, last_watered)
        )
        conn.commit()

    return redirect(url_for('index'))

@app.route('/water/<int:plant_id>')
def water_plant(plant_id):
    last_watered = datetime.now().strftime('%Y-%m-%d')
    with sqlite3.connect('plants.db') as conn:
        cursor = conn.cursor()
        cursor.execute('UPDATE plants SET last_watered = ? WHERE id = ?', (last_watered, plant_id))
        conn.commit()
    return redirect(url_for('index'))

@app.route('/delete/<int:plant_id>')
def delete_plant(plant_id):
    with sqlite3.connect('plants.db') as conn:
        cursor = conn.cursor()
        cursor.execute('DELETE FROM plants WHERE id = ?', (plant_id,))
        conn.commit()
    return redirect(url_for('index'))

if __name__ == '__main__':
    init_db()
    # To run this, you would typically use a command like `flask run`
    # For this example, we'll just show the setup.
    # To make this runnable in a real environment, you'd need to
    # manage the templates in a 'templates' directory.
    
    # Create a dummy templates/index.html for demonstration if it doesn't exist
    import os
    if not os.path.exists('templates'):
        os.makedirs('templates')
    with open('templates/index.html', 'w') as f:
        f.write('''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Watering Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-700">My Plant Watering Schedule</h1>
            <p class="text-gray-600 mt-2">Never forget to water your green friends again!</p>
        </header>

        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Add a New Plant</h2>
            <form action="/add" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-600">Plant Name</label>
                    <input type="text" name="name" id="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="species" class="block text-sm font-medium text-gray-600">Species (Optional)</label>
                    <input type="text" name="species" id="species" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="watering_frequency" class="block text-sm font-medium text-gray-600">Water Every (days)</label>
                    <input type="number" name="watering_frequency" id="watering_frequency" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                </div>
                <div class="md:col-span-3 text-center mt-4">
                     <button type="submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Add Plant</button>
                </div>
            </form>
        </div>

        <div>
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">My Plants</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for plant in plants %}
                <div class="bg-white rounded-lg shadow-md p-5 border-l-4 {% if plant.needs_water %}border-red-500{% else %}border-green-500{% endif %}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">{{ plant.name }}</h3>
                            <p class="text-gray-500">{{ plant.species }}</p>
                        </div>
                        <a href="/delete/{{ plant.id }}" class="text-red-500 hover:text-red-700 font-semibold" onclick="return confirm('Are you sure you want to delete this plant?');">&times;</a>
                    </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <p><strong>Last Watered:</strong> {{ plant.last_watered }}</p>
                        <p><strong>Next Watering:</strong> {{ plant.next_watering }}</p>
                        <p><strong>Watering Frequency:</strong> Every {{ plant.watering_frequency }} days</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                        {% if plant.needs_water %}
                            <p class="text-red-600 font-semibold">Needs watering!</p>
                            <p class="text-sm text-gray-500">{{ -plant.days_until_watering }} days overdue</p>
                        {% else %}
                             <p class="text-green-600 font-semibold">Watering is on schedule</p>
                            <p class="text-sm text-gray-500">{{ plant.days_until_watering }} days until next watering</p>
                        {% endif %}
                    </div>
                    <div class="mt-4">
                         <a href="/water/{{ plant.id }}" class="w-full block text-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">Water Now</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

</body>
</html>
        ''')
    print("Flask app setup complete. To run, save this as app.py, create a templates/index.html, and run 'flask run'.")
    # In a real scenario, you'd run this with a WSGI server.
    # For this interactive environment, we'll just confirm the setup.
